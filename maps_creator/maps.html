<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="mapid" style="height: 600px;"></div>
    <input id="geojson-file" type="file" accept=".geojson" />
    <input id="csv-file" type="file" accept=".csv" />

    <ul id="layer-control"></ul>

    <button id="download-button">Download Layer</button>

    <script>
        var mymap = L.map('mapid').setView([51.505, -0.09], 13);
        var layers = {};

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(mymap);

        document.getElementById('geojson-file').addEventListener('change', function(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var contents = e.target.result;
                var geojson = JSON.parse(contents);
                var layer = L.geoJSON(geojson).addTo(mymap);
                var id = Date.now().toString();
                layers[id] = layer;
                addLayerControl(file, layer, id);
                addPopupToLayer(layer);
            };
            reader.readAsText(file);
        });

        document.getElementById('csv-file').addEventListener('change', function(e) {
            var file = e.target.files[0];
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    var geojson = {
                        type: "FeatureCollection",
                        features: results.data.map(function(row) {
                            if (row.latitude && row.longitude) {
                                return {
                                    type: "Feature",
                                    properties: row,
                                    geometry: {
                                        type: "Point",
                                        coordinates: [row.longitude, row.latitude]
                                    }
                                };
                            }
                        }).filter(Boolean)
                    };
                    var layer = L.geoJSON(geojson, {
                        pointToLayer: function (feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 8,
                                fillColor: "#ff7800",
                                color: "#000",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        }
                    }).addTo(mymap);
                    var id = Date.now().toString();
                    layers[id] = layer;
                    addLayerControl(file, layer, id);
                    addPopupToLayer(layer);
                },
                error: function(err, file, inputElem, reason) {
                    console.log(err, file, inputElem, reason);
                },
            });
        });

        document.getElementById('download-button').addEventListener('click', function() {
            var mapNode = document.getElementById('mapid');
            var clonedNode = mapNode.cloneNode(true); // clone the map node

            // Add necessary scripts and styles
            var scriptNode = document.createElement('script');
            scriptNode.setAttribute('src', 'https://unpkg.com/leaflet/dist/leaflet.js');
            clonedNode.appendChild(scriptNode);

            var styleNode = document.createElement('link');
            styleNode.setAttribute('rel', 'stylesheet');
            styleNode.setAttribute('href', 'https://unpkg.com/leaflet/dist/leaflet.css');
            clonedNode.appendChild(styleNode);

            var htmlData = clonedNode.outerHTML;
            var dataStr = "data:text/html;charset=utf-8," + encodeURIComponent(htmlData);
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "layer.html");
            document.body.appendChild(downloadAnchorNode); // append the element to the body
            downloadAnchorNode.click(); // simulate a click
            document.body.removeChild(downloadAnchorNode); // remove the element from the body
        });
        
        function addLayerControl(file, layer, id) {
            var li = document.createElement('li');
            li.textContent = file.name;
            li.id = id;

            var removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.addEventListener('click', function() {
                var confirmDelete = confirm('Are you sure you want to delete this layer?');
                if (confirmDelete) {
                    mymap.removeLayer(layers[id]);
                    delete layers[id];
                    li.remove();
                }
            });

            var renameButton = document.createElement('button');
            renameButton.textContent = 'Rename';
            renameButton.addEventListener('click', function() {
                var newName = prompt('Enter new name');
                if (newName) {
                    li.textContent = newName;
                    li.appendChild(moveUpButton);
                    li.appendChild(moveDownButton);
                    li.appendChild(opacityButton);
                    li.appendChild(colorButton);
                    li.appendChild(removeButton);
                    li.appendChild(renameButton);
                }
            });

            var colorButton = document.createElement('button');
            colorButton.textContent = 'Change Color';
            colorButton.addEventListener('click', function() {
                var colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.addEventListener('input', function() {
                    layer.setStyle({
                        color: colorInput.value
                    });
                });
                colorInput.click();
            });

            var opacityButton = document.createElement('button');
            opacityButton.textContent = 'Change Opacity';
            opacityButton.addEventListener('click', function() {
                var newOpacity = prompt('Enter new opacity (0.0 - 1.0)');
                if (newOpacity >= 0 && newOpacity <= 1) {
                    layer.setStyle({
                        fillOpacity: newOpacity
                    });
                } else {
                    alert('Invalid opacity value. Please enter a number between 0.0 and 1.0');
                }
            });

            var moveUpButton = document.createElement('button');
            moveUpButton.textContent = 'Move Up';
            moveUpButton.addEventListener('click', function() {
                layer.bringToFront();
                var ul = document.getElementById('layer-control');
                if (ul.lastChild && li.previousSibling) {
                    ul.insertBefore(li, li.previousSibling);
                }
            });

            var moveDownButton = document.createElement('button');
            moveDownButton.textContent = 'Move Down';
            moveDownButton.addEventListener('click', function() {
                layer.bringToBack();
                var ul = document.getElementById('layer-control');
                if (ul.firstChild && li.nextSibling) {
                    ul.insertBefore(li.nextSibling, li);
                }  
            });

            li.appendChild(moveUpButton);
            li.appendChild(moveDownButton);
            li.appendChild(opacityButton);
            li.appendChild(colorButton);
            li.appendChild(removeButton);
            li.appendChild(renameButton);
            document.getElementById('layer-control').appendChild(li);
        }

        function addPopupToLayer(layer) {
            layer.on('click', function(e) {
                var properties = e.layer.feature.properties;
                var popupContent = '<h3>Space Data</h3>';
                for (var key in properties) {
                    popupContent += '<p><strong>' + key + ':</strong> ' + properties[key] + '</p>';
                }
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(popupContent)
                    .openOn(mymap);
            });
        }
    </script>
</body>
</html>